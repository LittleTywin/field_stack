wait_for_db refactoring